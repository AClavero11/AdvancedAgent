<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Assistant</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f5f5f5;
            padding-bottom: 50px;
        }
        .navbar-brand img {
            height: 50px;
        }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .chat-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
        }
        .user-message {
            background-color: #e9ecef;
            margin-left: 15%;
        }
        .assistant-message {
            background-color: #d1e7dd;
            margin-right: 15%;
        }
        .message-content {
            white-space: pre-wrap;
        }
        .model-info {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }
        #response {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .spinner-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .conversation-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .conversation-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="https://www.advancedac.com/wp-content/uploads/2021/02/logo-ADAC@2x.png" alt="Advanced Aerospace Components">
            </a>
            <div class="navbar-text ms-3">
                <h3>Advanced AI Assistant</h3>
                <p class="text-muted mb-0">Powered by enterprise-grade language models</p>
            </div>
            <div class="ms-auto">
                <div id="auth-status">
                    <button id="login-button" class="btn btn-outline-primary me-2">Log In</button>
                    <button id="register-button" class="btn btn-primary">Sign Up</button>
                </div>
                <div id="user-info" style="display: none;">
                    <span id="user-email" class="me-2"></span>
                    <button id="logout-button" class="btn btn-outline-secondary btn-sm">Log Out</button>
                </div>
            </div>
        </div>
    </nav>


    <!-- Main Container -->
    <div class="container" id="main-container" style="display: none;">
        <div class="row">
            <!-- Sidebar with Conversations -->
            <div class="col-md-3 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Conversations</h5>
                        <button id="new-conversation" class="btn btn-sm btn-outline-primary">New</button>
                    </div>
                    <div class="card-body p-0">
                        <div id="conversation-list" class="conversation-list">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Chat Area -->
            <div class="col-md-9">
                <div class="chat-container">
                    <div class="mb-3">
                        <label for="model" class="form-label">Choose AI Engine:</label>
                        <select class="form-select" id="model">
                            <option value="openrouter/auto">Auto (Best Available)</option>
                            <option value="anthropic/claude-3-sonnet">Claude 3.5 Sonnet</option>
                            <option value="anthropic/claude-3-opus">Claude 3.5 Opus</option>
                            <option value="google/palm-2">Google PaLM 2</option>
                            <option value="meta-llama/llama-2-70b-chat">Meta Llama 2 70B</option>
                            <option value="mistralai/mistral-7b-instruct">Mistral 7B</option>
                        </select>
                    </div>
        
                    <div class="mb-3">
                        <label for="prompt" class="form-label">Your question or request:</label>
                        <textarea class="form-control" id="prompt" rows="5"></textarea>
                    </div>
        
                    <div class="mb-3">
                        <label for="file-upload" class="form-label">Attach files (optional):</label>
                        <input class="form-control" type="file" id="file-upload" multiple>
                    </div>
        
                    <button type="button" id="submit-button" class="btn btn-primary mb-4">
                        Ask AI Assistant
                    </button>
        
                    <div id="response" class="mb-4">
                        <!-- Messages will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Auth Container -->
    <div id="auth-container" class="auth-container">
        <ul class="nav nav-tabs mb-3" id="auth-tabs">
            <li class="nav-item">
                <a class="nav-link active" id="login-tab" data-bs-toggle="tab" href="#login-form">Log In</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="register-tab" data-bs-toggle="tab" href="#register-form">Sign Up</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="login-form">
                <form id="login-form-element">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="login-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Log In</button>
                    <div id="login-error" class="alert alert-danger mt-3" style="display: none;"></div>
                </form>
            </div>
            <div class="tab-pane fade" id="register-form">
                <form id="register-form-element">
                    <div class="mb-3">
                        <label for="register-email" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="register-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="register-password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="register-password" required minlength="8">
                        <div class="form-text">Password must be at least 8 characters long.</div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Sign Up</button>
                    <div id="register-error" class="alert alert-danger mt-3" style="display: none;"></div>
                    <div id="register-success" class="alert alert-success mt-3" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>


    <!-- Loading Spinner (Hidden by Default) -->
    <div class="spinner-container" id="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Configuration
        const API_URL = 'https://your-api-gateway-url.amazonaws.com/default';  // REPLACE WITH YOUR API URL
        const S3_UPLOAD_URL = 'https://your-s3-upload-url.amazonaws.com';  // REPLACE WITH YOUR S3 UPLOAD URL
        
        // State Management
        let currentUser = null;
        let currentConversationId = null;
        let uploadedFiles = [];
        
        // DOM Elements
        const mainContainer = document.getElementById('main-container');
        const authContainer = document.getElementById('auth-container');
        const authStatus = document.getElementById('auth-status');
        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const logoutButton = document.getElementById('logout-button');
        const submitButton = document.getElementById('submit-button');
        const promptInput = document.getElementById('prompt');
        const modelSelect = document.getElementById('model');
        const responseContainer = document.getElementById('response');
        const loadingSpinner = document.getElementById('loading-spinner');
        const fileUpload = document.getElementById('file-upload');
        const loginForm = document.getElementById('login-form-element');
        const registerForm = document.getElementById('register-form-element');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const registerSuccess = document.getElementById('register-success');
        const newConversationButton = document.getElementById('new-conversation');
        const conversationList = document.getElementById('conversation-list');


        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already logged in
            checkAuthStatus();
            
            // Set up event listeners
            loginButton.addEventListener('click', () => {
                authContainer.style.display = 'block';
                mainContainer.style.display = 'none';
                document.getElementById('login-tab').click();
            });
            
            registerButton.addEventListener('click', () => {
                authContainer.style.display = 'block';
                mainContainer.style.display = 'none';
                document.getElementById('register-tab').click();
            });
            
            logoutButton.addEventListener('click', logoutUser);
            submitButton.addEventListener('click', submitPrompt);
            fileUpload.addEventListener('change', handleFileUpload);
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            newConversationButton.addEventListener('click', startNewConversation);
            
            // Tab navigation
            const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Hide all tab panes
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    
                    // Show the selected tab pane
                    const target = document.querySelector(tab.getAttribute('href'));
                    target.classList.add('show', 'active');
                });
            });
        });


        // Check if user is already logged in
        function checkAuthStatus() {
            const idToken = localStorage.getItem('idToken');
            const userEmail = localStorage.getItem('userEmail');
            
            if (idToken && userEmail) {
                // User is logged in
                setLoggedInState(userEmail);
                loadConversations();
            } else {
                // User is not logged in
                setLoggedOutState();
            }
        }


        // Set the UI to logged in state
        function setLoggedInState(email) {
            currentUser = email;
            authStatus.style.display = 'none';
            userInfo.style.display = 'block';
            userEmail.textContent = email;
            authContainer.style.display = 'none';
            mainContainer.style.display = 'block';
        }


        // Set the UI to logged out state
        function setLoggedOutState() {
            currentUser = null;
            currentConversationId = null;
            authStatus.style.display = 'block';
            userInfo.style.display = 'none';
            authContainer.style.display = 'block';
            mainContainer.style.display = 'none';
            responseContainer.innerHTML = '';
        }


        // Handle user login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showLoginError('Please enter email and password');
                return;
            }
            
            try {
                loadingSpinner.style.display = 'flex';
                loginError.style.display = 'none';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requestType: 'auth',
                        authAction: 'login',
                        email,
                        password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Login successful
                    localStorage.setItem('idToken', data.idToken);
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                    localStorage.setItem('userEmail', email);
                    
                    setLoggedInState(email);
                    loadConversations();
                    loginForm.reset();
                } else {
                    // Login failed
                    showLoginError(data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('An error occurred during login. Please try again.');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }


        // Handle user registration
        async function handleRegister(e) {
            e.preventDefault();
            
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!email || !password) {
                showRegisterError('Please enter email and password');
                return;
            }
            
            if (password.length < 8) {
                showRegisterError('Password must be at least 8 characters long');
                return;
            }
            
            try {
                loadingSpinner.style.display = 'flex';
                registerError.style.display = 'none';
                registerSuccess.style.display = 'none';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requestType: 'auth',
                        authAction: 'register',
                        email,
                        password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Registration successful
                    showRegisterSuccess('Registration successful! You can now log in.');
                    registerForm.reset();
                    // Switch to login tab after 2 seconds
                    setTimeout(() => {
                        document.getElementById('login-tab').click();
                    }, 2000);
                } else {
                    // Registration failed
                    showRegisterError(data.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showRegisterError('An error occurred during registration. Please try again.');
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }


        // Logout user
        function logoutUser() {
            localStorage.removeItem('idToken');
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userEmail');
            setLoggedOutState();
        }


        // Load user conversations
        async function loadConversations() {
            try {
                const idToken = localStorage.getItem('idToken');
                
                if (!idToken) {
                    return;
                }
                
                conversationList.innerHTML = '<div class="p-3 text-center">Loading...</div>';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requestType: 'listConversations',
                        userId: currentUser
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.conversations) {
                    renderConversationList(data.conversations);
                } else {
                    conversationList.innerHTML = '<div class="p-3 text-center">No conversations found</div>';
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                conversationList.innerHTML = '<div class="p-3 text-center text-danger">Failed to load conversations</div>';
            }
        }


        // Render conversation list
        function renderConversationList(conversations) {
            if (conversations.length === 0) {
                conversationList.innerHTML = '<div class="p-3 text-center">No conversations yet</div>';
                return;
            }
            
            conversationList.innerHTML = '';
            
            conversations.forEach(conversation => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.dataset.id = conversation.conversation_id;
                
                // Format timestamp
                const date = new Date(conversation.last_updated * 1000);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                item.innerHTML = `
                    <div class="fw-bold">${conversation.title}</div>
                    <small class="text-muted">${formattedDate}</small>
                `;
                
                item.addEventListener('click', () => loadConversation(conversation.conversation_id));
                
                conversationList.appendChild(item);
            });
        }


        // Load a specific conversation
        async function loadConversation(conversationId) {
            try {
                currentConversationId = conversationId;
                responseContainer.innerHTML = '';
                loadingSpinner.style.display = 'flex';
                
                // Highlight selected conversation
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('bg-light');
                });
                document.querySelector(`.conversation-item[data-id="${conversationId}"]`)?.classList.add('bg-light');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requestType: 'getConversation',
                        conversationId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.messages) {
                    // Render messages
                    data.messages.forEach(message => {
                        if (message.role === 'user') {
                            addUserMessage(message.content);
                        } else if (message.role === 'assistant') {
                            addAssistantMessage(message.content);
                        }
                    });
                    
                    // Scroll to bottom
                    responseContainer.scrollTop = responseContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
                responseContainer.innerHTML = '<div class="alert alert-danger">Failed to load conversation</div>';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }


        // Start a new conversation
        function startNewConversation() {
            currentConversationId = null;
            responseContainer.innerHTML = '';
            promptInput.value = '';
            uploadedFiles = [];
            fileUpload.value = '';
            
            // Deselect all conversations
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('bg-light');
            });
        }


        // Handle file uploads
        function handleFileUpload(e) {
            // This is just a placeholder for file upload functionality
            // You would implement S3 upload here
            
            const files = e.target.files;
            
            if (files.length > 0) {
                // For now, just store the filenames
                uploadedFiles = Array.from(files).map(file => file.name);
                console.log('Files selected:', uploadedFiles);
            }
        }


        // Submit a prompt to the AI
        async function submitPrompt() {
            const prompt = promptInput.value.trim();
            const model = modelSelect.value;
            
            if (!prompt) {
                return;
            }
            
            if (!currentUser) {
                alert('You must be logged in to use the AI assistant');
                return;
            }
            
            // Add user message to the UI
            addUserMessage(prompt);
            
            // Clear input
            promptInput.value = '';
            
            // Show loading spinner
            loadingSpinner.style.display = 'flex';
            
            try {
                // Prepare file URLs (this would be replaced with actual S3 URLs)
                const fileUrls = uploadedFiles.map(file => `https://example.com/uploads/${file}`);
                
                // Call the API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt,
                        model,
                        userId: currentUser,
                        conversationId: currentConversationId,
                        fileUrls
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.result) {
                    // Add AI response to the UI
                    const content = data.result.content;
                    const modelUsed = data.result.model_used || model;
                    
                    addAssistantMessage(content, modelUsed);
                    
                    // Update the conversation ID if this is a new conversation
                    if (!currentConversationId && data.result.conversation_id) {
                        currentConversationId = data.result.conversation_id;
                        
                        // Refresh conversation list
                        loadConversations();
                    }
                } else {
                    // Add error message
                    const errorMsg = data.error || 'An error occurred while processing your request';
                    addErrorMessage(errorMsg);
                }
            } catch (error) {
                console.error('Error submitting prompt:', error);
                addErrorMessage('Failed to connect to the AI service. Please try again.');
            } finally {
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                
                // Clear uploaded files
                uploadedFiles = [];
                fileUpload.value = '';
            }
            
            // Scroll to bottom
            responseContainer.scrollTop = responseContainer.scrollHeight;
        }


        // Add user message to the UI
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message user-message';
            messageElement.innerHTML = `
                <div class="message-content">${escapeHtml(message)}</div>
            `;
            responseContainer.appendChild(messageElement);
        }


        // Add assistant message to the UI
        function addAssistantMessage(message, modelInfo) {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message assistant-message';
            
            // Format message with markdown-like formatting
            const formattedMessage = formatMessage(message);
            
            messageElement.innerHTML = `
                <div class="message-content">${formattedMessage}</div>
                ${modelInfo ? `<div class="model-info">Model: ${modelInfo}</div>` : ''}
            `;
            responseContainer.appendChild(messageElement);
        }


        // Add error message to the UI
        function addErrorMessage(message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'alert alert-danger';
            errorElement.textContent = message;
            responseContainer.appendChild(errorElement);
        }


        // Show login error
        function showLoginError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }


        // Show register error
        function showRegisterError(message) {
            registerError.textContent = message;
            registerError.style.display = 'block';
        }


        // Show register success
        function showRegisterSuccess(message) {
            registerSuccess.textContent = message;
            registerSuccess.style.display = 'block';
        }


        // Format message with code blocks and basic markdown
        function formatMessage(text) {
            if (!text) return '';
            
            // Escape HTML to prevent XSS
            let formatted = escapeHtml(text);
            
            // Format code blocks
            formatted = formatted.replace(/```([a-zA-Z]*)\n([\s\S]*?)\n```/g, '<pre><code>$2</code></pre>');
            
            // Format inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Format bold text
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Format italic text
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Convert newlines to <br>
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }


        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>